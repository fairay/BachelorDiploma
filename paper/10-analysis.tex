\section{Аналитическая часть}
\subsection{Актуальность проблемы}
	В данный момент торговые розничные сети (другое название -- ретейл) динамически развиваются и с каждым годом занимают всё большую долю в общем объёме розничной торговли\cite{subj:demand}. Деятельность подобных предприятий тесно связана с управлением цепочками поставок \, (SCM \, --- \, Supply Chain Management), под которым понимается комплекс подходов, способствующий эффективной интеграции поставщиков, производителей, дистрибьюторов и продавцов, в том числе, в части хранения и перемещения продукции от точки изготовления до точки потребления.. Этот процесс можно разделить на следующие этапы\cite{subj:scm}. 
	\begin{enumerate}
		\item Планирование. Принимается решение об управлении жизненным циклом товаров, объёмах производства и закупок.
		\item Закупки. Происходит управление снабжением, оцениваются и выбираются поставщики.
		\item Производство. Включает в себя процесс производства, контроль технологических изменений, управление качеством и т.д.
		\item Доставка. Состоит из трёх основных процессов: управление заказами, управление складом и транспортировка.
		\item Возврат. На этом этапе определяются элементы возврата товара, составляются графики возврата и направления на уничтожение и переработку.
	\end{enumerate}
	
	Среди перечисленных задач выделим отдельно  транспортную логистику. Затраты на неё существенны, что обосновывается её сложностью и жизненной важностью для деятельности фирмы. 
	
	Таким образом, расширение сегмента розничных сетей на рынке влечёт за собой повышение спроса на перевозку товаров. Большинство транспортных компаний прибегают к использованию программного обеспечения для ускорения и упрощения различных этапов процесса перевозки\cite{subj:auto_eff}.  Автоматизация данной работы позволяет повысить её эффективность, в том числе за счёт снижения транспортных издержек. Это должно положительно сказаться на стоимости услуг данной компании, что, в свою очередь, может увеличить спрос на её услуги.

\subsection{Анализ предметной области}
	Задачей транспортной логистики является организация перемещения груза между двумя местами по оптимальному маршруту\cite{subj:main}. В данном случае оптимальным считается тот маршрут, который позволяет перевезти объекты в предусмотренные сроки с наименьшими затратами и вредом для них. Стоит отметить, что зачастую возможные маршруты не являются оптимальными сразу по всем критериям, поэтому приходится принимать компромиссные решения.
	
	Случаи, когда задачи розничной торговли, транспортировки и складирования товара (а иногда даже производства) выполняются одной фирмой достаточно редки и характерны только для крупного бизнеса. Этот подход организации улучшает интеграцию всех перечисленных элементов логистической системы, что способно снизить издержки на каждом из этапов. Малые предприятия не располагают подобными ресурсами и, как правило, пользуются услугами других компаний для выполнения данной функции.  
	
	В рамках данной работы рассматривается решение задач автоматического планирования для автомобильной транспортной компании, клиентами которой являются малые и средние ретейл-предприятия.
	
	Логистика малого бизнеса имеет ряд особенностей\cite{subj:small_business}. Как было отмечено, небольшие торговые организации не способны содержать необходимый штат сотрудников, транспортных средств и т.д., а также не обладают достаточно большим оборотом товаров для собственной организации перевозки. Малые объёмы поставок для каждого отдельного предприятия приводят к тому, что компании-перевозчики совмещают планируют один маршрут сразу через несколько точек доставки.
	
	Можно заключить, что обыкновенный процесс работы фирмы доставки заключается в следующем. Несколько ретейл-предприятий формируют заказы с указанием заказываемых товаров и их объёмов. Транспортная компания определяет совместные маршруты и средства доставки, формирует заказ для складского предприятия. Назначенные грузовые автомобили загружаются на складе и развозят груз по нужным пунктам, после чего возвращаются на стоянку.

\subsection{Сравнение с аналогами}
	Системы управления перевозками \, (TMS -- Transportation management \, system), как было отмечено выше, являются востребованными для предприятий, занимающихся логистикой. Данные системы, в основном, решают следующий перечень задач\cite{subj:tms_cmp}:
	\begin{itemize}
		\item расчет логистических затрат;
		\item оптимальное использование транспортных средств для минимизации
		общих расходов;
		\item повышение качества обслуживания -- соблюдение сроков доставки, установленных транспортной службой компании;
		\item автоматизация \, процесса \, транспортного планирования и управления, \, обеспечивающая решение для конкурентного транспортного планирования
		и управления;
		\item повышение производительности труда работников при планировании и
		организации грузовых перевозок.
	\end{itemize}

	\hfill
	
	В число наиболее популярных в России входят следующие TMS.
	\begin{itemize}
		\item Oracle Transportation Management.
		\item SAP TM.
		\item 1С: TMS Логистика. Управление перевозками.
	\end{itemize}

	Перечисленные программы позволяют осуществлять составление, расчёт стоимостей, поручение и контроль выполнения плана транспортировок. Также зачастую реализуются различные интерфейсы и функционал для водителей, логистов и прочих работников. Таким образом, общей чертой данных систем является комплексный подход к решению задач транспортной логистики. Предпринимается попытка удовлетворить все потребности, так или иначе связанные с обработкой данных. 
	
	Сравнительный анализ основного функционала\cite{subj:tms_cmp} указанных TMS приведен в таблице\ref{cmp_table}.
	
	\begin{table}[h]
		\begin{center}
			\caption{Сравнение существующих решений}
			\label{cmp_table}
			\begin{tabular}{| p{5cm} | p{2.5cm} | p{2.5cm} | p{2.5cm} |}
				\hline
				\backslashbox{\textbf{Функция}}{\textbf{TMS}} &
				OTM &
				SAP &
				1C \\
				
				\hline
				Прогнозирование & 
				да &
				да &
				нет \\
				 
				\hline
				Планирование заказов &
				да &
				частично &
				частично \\
				
				\hline
				Распределение перевозок между исполнителями за период &
				да &
				да &
				нет \\
				
				\hline
			\end{tabular}
		\end{center}
	\end{table}
	
	Среди указанных программ автоматическое планирование с учётом наиболее важных факторов позволяет Oracle TM. В случае других TMS планирование не реализовано настолько детально. Ввиду крайне высокой цены\cite{subj:tms_cmp} на Oracle Transportation Management и в целом на подобные программы, небольшие транспортные фирмы не могут позволить себе столь высокие расходы. Решением может быть использование представленной в данной работе программы совместно со сравнительно недорогой TMS, решающей другие задачи транспортного управления.

\subsection{Детализация задачи}
	Требуется разработать метод, выполняющий оптимальную планировку маршрутов доставки заказов от складов до потребителей (ретейл-фирм). Целью создания продукта является определение маршрутов, которые будут наиболее выгодными для компании. Выгода в данном случае заключается во множестве факторов, но в первую очередь под ней подразумевается денежная прибыль.
	
	Целевой пользователь --- логист транспортной компании. Для него применение программы нужно для получения рекомендаций по заданию маршрутов в определённый момент времени. После этого работник может проанализировать полученные маршруты, внести в них свои корректировки и заняться последующими этапами своей деятельности (непосредственно организацией грузоперевозок, документооборотом и т.д.).
	
	Исходными данными для работы метода является информация о следующих объектах:
	\begin{itemize}
		\item грузовые машины, входящие в автопарк фирмы;
		\item перевозимые товары;
		\item стоянка грузовиков;
		\item поставщики и потребители товара (в данном случае склады и розничные торговые фирмы);
		\item пути между вышеописанными пунктами маршрута;
		\item заказы.
	\end{itemize}

	Результатом работы должны стать предлагаемые маршруты. Схематически пример транспортной системы представлен на рисунке \ref{pic:model}, где стрелками обозначены маршруты, выбранные методом как оптимальные.
	
	\begin{figure}[h!] 
		\begin{center}
			{\includegraphics[scale=0.9, angle=0]{img/model.pdf}}
			\caption{Схема модели}
			\label{pic:model}
		\end{center}
	\end{figure}
	
	\subsection{Допущения и ограничения задачи}
	Рассмотрим упомянутые объекты, обозначим допущения и ограничения для задачи.
	
	Одним из главных вопросов является выделение критерия оптимизации, служащего для оценки плана маршрутов. Как было отмечено выше, главным является денежная прибыль, то есть повышение доходов и уменьшение затрат.   
	
	Первое достигается только через выполнение большего объёма грузоперевозок. Однако, количество перевозимого груза определяется не при планировании маршрутов перевозки товаров, а при заключении договора между транспортной компанией и ритейл-фирмой. Поэтому, будем считать, что объём и состав заказов фиксирован и их выполнение в срок является обязательным. Это обусловленно большими штрафами за невыполнение договора, как правило существенно превышающими рассмотренные далее затратами. Также при планировании маршрутов нельзя повлиять на объём хранимых товаров, так как это является задачей управления складами.
	
	Деятельность транспортной фирмы связана со множеством статей затрат, но пути перевозки влияют только на время доставки и пробег грузовиков, что в свою очередь отражается на средствах, затрачиваемых на топливо, оплату труда водителя и амортизацию транспортных средств. Для упрощения, будем считать, что этот расход можно вычислить используя длину маршрута и среднюю затрату на километр. Оценка по времени для расчёта стоимости подходит меньше, так как одинаковое время затраченное в пробке и на свободной дороге ведёт к совершенно разным результатам\cite{subj:fuel_waste}.
	
	Путь между пунктами доставки достаточно описать с использованием расстояния и времени. Следует уточнить, что последняя величина является \, крайне динамичной, ввиду различной загруженности дорог в разные периоды суток, возможностью ДТП и прочих сложно прогнозируемых событий. Поэтому время задаётся усреднённый значением за весь период дня.
	
	В расчёте времени, затрачиваемого на рейс, следует учитывать продолжительность загрузки и выгрузки товаров, а также интервалов между разными заказами. Эти параметры зависят от большого количества факторов. В данной работе время не является целью оптимизации в и служит только для задания ограничения. Поэтому данные величины могут быть приняты постоянными.
	
	Таким образом, продолжительность рейса может быть рассчитанна как сумма длительности проезда по всем путям и времени погрузки на пунктах складирования и доставки.
	
	Решение проблемы расположения груза в автомобиле и расчёта его вместимости в общем случае является достаточно затруднительным. Так, например, хрупкие вещи могут не допускать размещения другого груза поверх них. В решаемой задаче поставка товаров является оптовой, поэтому примем распространённый в этой сфере подход: все виды товаров поставляются в тарах, которые имеют определённый объём и не требуют специальных условий транспортировки. В таком случае можно считать, что грузовик вмещает такое количество тар, при котором их суммарный объём не превышает объёма заполняемого кузова. В рамках данной задачи в качестве объёма тар устанавливается единственное значение. 
	
	Ещё одним допущением явлется решене о том, что доставка производится однотипными грузовиками, т.е. они все обладают одинаковой вместимостью.
	
	Данное решение обусловленно анализом реальной ситуации в ретейле, который показал, что транспортные фирмы зачастую действительно закупают или арендуют грузовые автомобили одной модели или разных, но со схожими характеристиками. Такой подход позволяет снизить затраты на их содержание и техническое обслуживание. Таким образом, данное упрощение существенно не влияет на применимость метода к реальным системам.
	
	Первым и последним пунктом любого рейса является автостоянка транспортной фирмы, причём в обоих случаях машина не содержит каких-либо грузов. Также будем считать, что в каждом маршруте склад посещается однократно. Данное ограничение позволяет отказаться от длинных рейсов с промежуточными пополнениями.

\subsection{Формализация задачи}
	\subsubsection{Описание учитываемых факторов}
	Сформулированная задача является задачей поиска оптимального решения, а именно транспортной задачей \cite{trans:main}. Она решает проблему составления такого плана перевозок, который будет иметь наименьшие затраты. 
	
	В простейшем случае модель транспортной системы может рассматривается как множество пунктов производства однородного продукта и множество его потребителей. Известны затраты перевозки одной единицы товара для любой пары производителя и потребителя.
	
	Использование такой модели для решения поставленной задачи некорректно, так как она не учитывает следующие факторы.
	\begin{itemize}
		\item Склады и транспортные средства ограничены и обладают конечной вместимостью.
		\item Рассматриваемый магазин оперирует сразу множеством товаров, которые невзаимозаменяемые.
		\item Рассматриваются только маршруты "Производитель -- Потребитель"\, тогда как в рассмотренной модели маршрут может проходить сразу через несколько потребителей. Таким образом и перевозимый одним транспортом груз зависит сразу от нескольких потребителей.
	\end{itemize}
		
	Основной способ решения вопроса доставки множества продуктов \, --- \, условное разбиению поставщиков и потребителей из общих на работающих только с одним продуктом. Таким образом задача сводится к множеству однопродуктовых, но с общим набором рейсов, что накладывает совместные ограничения.
	
	\subsubsection{Описание математической модели задачи}
	Для дальнейшей разработки метода решения поставленной задачи необходимо описать транспортную систему с помощью некой математической модели. Таким образом учитываемые параметры и ограничения будут формализованы с помощью определенных значений. Так как метод должен составлять маршруты, то в первую очередь стоит формализовать представление формирующих их дорог. 
	
	Наилучшим образом подходит представление с помощью неориентированного связанного взвешенного графа, вершинами которого его являются пункты маршрута (то есть стоянка, склады или потребители), а рёбрами связывающие их дороги. Весами рёбер будет являться протяжённость соответствующей ему дороги.
	
	Задачу можно сформулировать как поиск такого множества циклов, в котором выполняются следующие требования:
	\begin{itemize}
		\item ‌циклы начинающихся на стоянке транспортной фирмы;
		\item ‌за каждым циклом закреплена задача перевозки определённого набора товаров некоторому набору потребителей;
		\item ‌соблюдаются ограничения модели;
		\item ‌является самым оптимальным среди всех множеств, удовлетворяющих предыдущим требованиям.
	\end{itemize}
	
	
	\subsubsection{Формализация данных}
	Дополним описание математической формализацией данных метода. 
	
	\textbf{Фиксированные величины.}
	
	$Vol$ -- объём одной тары, $Con$ -- стоимость топлива (литр / у.е.)
	
	\textbf{Пункты маршрута и дороги.}
	
	$A_i$ -- склады с запасом продукции в $a_i$, ($i = \overline{1, N_a}$). $B_i$ -- потребители с потребностью продукции в $a_i$, ($i = \overline{1, N_b}$).
	
	Данные об $A$, $B$ и автостоянке объединяются в понятие пункта маршрута $P$, ранее упомянутого при описании графа. Общее количество пунктов опишем как $N_P= N_b+N_a+1$, распределение пунктов следующее:
	\begin{itemize}
		\item $i = 1$ -- автостоянка;
		\item $i = \overline{2, N_a + 1}$ -- склады;
		\item $i = \overline{N_a+2, N_b+N_a+1}$ -- потребители.
	\end{itemize} 
	
	Дороги, связывающие пункты описываются с помощью параметров $t_{ij} > 0, d_{ij} > 0$ -- время перемещения и расстояние между $P_i$ и $P_j$.
	
	\textbf{Продукция и её баланс.}
	
	$Prod_i$ -- продукт ($i = \overline{1, N_{prod}}$).
	
	$O_i$ --- начальный баланс товаров в $i$-м пункте. 
	 
	$O_{ij}$ --- баланс продукта $Prod_j$ в пункте $P_i$.  
	
	Баланс характеризует дефицит или профицит товаров для определённого пункта. В случае, если пунктом является склад, то за баланс принимается объём запасов. Если это потребитель, то балансом считается заказ со знаком минус. Одним из условий решения задачи является перераспределение продуктов с помощью перевозок таким образом, чтобы во всех пунктах был неотрицательный баланс. 
	
	\textbf{Транспорт и рейсы.}
	
	$T_i$ -- транспорт с вместимостью в $c$ (в кубометрах) и затратой топлива в $f$ (в литр / км) ($i = \overline{1, N_t}$). Как было сказано ранее, в данной задаче все грузовики обладают одинаковыми характеристиками.
	
	Рейсы обозначим как $R_i$ ($i = \overline{1, N_R}$). $RT_i = \overline{1, N_t}$ -- индекс транспорта, назначенного на $i$-й маршрут.
	
	$RP_i$ - вектор пунктов, задействованных в $i$-м рейсе. $RP_i[j]$ - индекс пункта, посещённый в $j$-ю очередь на $i$-м рейсе, где $j = \overline{1, N_{RP_i}}$.
	
	$v_{ijkl} \ge 0$ -- количество товара $Prod_l$ перевезённое $k$-м рейсом ($k = \overline{1, N_R}$) между $P_i$ и $P_j$, где $i \ne j$ и $i, j = \overline{1, N_P}$. 
	
	$t_{begin}, t_{end}$ обозначим как время начала и завершения рабочего дня. $t_{load}$, $t_{wait}$ зададим как время на загрузку/выгрузку товара и перерывом между рейсами.
	
	Вектор $v$, состоящий из множества маршрутов и удовлетворяющий ниже идущим условиям и ограничениям считается решением.
	
	\subsubsection{Формулирование условий решения и ограничений}    
	План перевозок можно считать решением задачи в случае, если поставки удовлетворили всех потребителей. В принятом обобщении пунктов это можно записать как формулу \ref{eq:solution}.
	\begin{equation}
		\label{eq:solution}
		O_{il} + \sum_{j=1}^{N_P} \sum_{k=1}^{N_t} (v_{jikl} - v_{ijkl}) \ge 0 \qquad  \forall l = \overline{1, N_{prod}}
	\end{equation}
	   
	Сформулируем ограничения модели. Ни на одном из этапов перевозки объём продукта не должен превысить максимальную вместимость транспорта.
	\begin{equation}
		\sum_{l=1}^{N_{Prod}} v_{ijkl} \cdot Vol \le c, \qquad \forall i, j \in \overline{1, N_P}, k \in \overline{1, N_t}
	\end{equation}

	Каждый рейс совершает только одну погрузку на складе. 
	
	\begin{equation}
		\exists! i: v_{RP_k[i]RP_k[i+1]k} > v_{RP_k[i-1]RP_k[i]k} \qquad \forall k \in \overline{1, N_R}
	\end{equation}

	Каждый рейс начинается и завершается на стоянке.
	\begin{equation}
		RP_k[1] = RP_k[N_{RP_k}] = 1 \qquad \forall k \in \overline{1, N_R}
	\end{equation}	
	
	\subsubsection{Формулирование критерия оптимизации}   
	Критерием оптимизации является минимизация затрат. Как было отмечено выше, планирование способно оказывать влияние только на стоимость всех рейсов. Целевая функция принимает следующий вид.
	\begin{equation}
		L(R) = Con \cdot \sum_{i=1}^{N_R} \sum_{j=1}^{N_{RP_i} - 1} f \cdot d_{RP_i[j] RP_i[j+1]} \to \min
	\end{equation}
	То есть сумма затрат каждого рейса. Так как было принято, что $Con$ и $f$ постоянны и одинаковы для любого транспорта, то критерий оптимизации можно упростить до следующего вида.
	\begin{equation}
		L(R) = \sum_{i=1}^{N_R} \sum_{j=1}^{N_{RP_i} - 1} d_{RP_i[j] RP_i[j+1]} \to \min
	\end{equation}

	\subsubsection*{Итог формализации}
	Приведём все описанные формализации в математическую модель рассматриваемой задачи поиска оптимального плана поставок.

	\begin{equation}
	\left\{ \begin{array}{ccc}	
		L(R) \to min \\
		O_{il} + \sum_{j=1}^{N_P} \sum_{k=1}^{N_t} (v_{jikl} - v_{ijkl}) \ge 0 \qquad  \forall l = \overline{1, N_{prod}} \\
		\\
		\sum_{l=1}^{N_{Prod}} v_{ijkl} \cdot Vol \le c, \qquad \forall i, j \in \overline{1, N_P}, k \in \overline{1, N_t} \\
		\exists! i: v_{RP_k[i]RP_k[i+1]k} > v_{RP_k[i-1]RP_k[i]k} \qquad \forall k \in \overline{1, N_R} \\
		RP_k[1] = RP_k[N_{RP_k}] = 1 \qquad \forall k \in \overline{1, N_R}\\
		
	\end{array}	\right.
	\end{equation}

\subsection{Описания метода решения}
	Учитывая перечисленные факторы, в качестве основы для решения сформулированной \, задачи возможно \, выбрать \, метод потенциалов \, в сетевой \, постановке\cite{trans:polycrit}. Он является модификацией симплекс-метода, применяющегося для многих оптимизационных задач, в том числе и классической транспортной задачи\cite{trans:potential}.
		
	Преимуществом такого метода является то, что он может быть модифицирован для прокладывания транзитных маршрутов и добавления ограничений на пропускную способность, что необходимо в рамках созданной математической модели.
	
	Метод решения поставленной задачи состоит из следующих трёх этапов.
	\begin{enumerate}
		\item Формирование опорного (начального) \, плана перевозок. Он соблюдает все поставленные ограничения, но не является оптимальным. Служит входным планом для первой итерации следующего этапа.
		\item Оптимизация плана. Производится итерационное изменение составленного плана с помощью метода потенциалов до тех пор, пока не будет достигнут план, при котором станет невозможно перестроение с меньшим значением критерия.
		\item Заключительный. Составление расписания для сформированного набора маршрутов.
	\end{enumerate} 

	Рассмотрим эти этапы подробнее.
	
	\subsubsection{Формирование опорного плана}
	В первую очередь формируется опорный план перевозок. В неё соблюдаются все ограничения модели, но при этом он не является оптимальным.
	
	Для формирования \, начальных маршрутов существует \, метод северо-западного угла и метод минимального элемента\cite{trans:comporation}. Фактически данные методы различаются лишь порядком выбора путей между пунктами для формирования маршрутов. Для данной задачи будем использовать последний, так как он эффективнее \cite{potential:polyindex} за счёт изначального учёта не только запасов и потребностей, но и протяжённости перевозок.
	
	Идея метода минимального элемента заключается в последовательном назначении маршрутов от поставщика к потребителю до полного удовлетворения потребности последних. Выбор осуществляется в порядке возрастания протяжённости дорог. По выбранному пути назначается перевозка на максимально возможное количество товаров (ограничивается наличием на складе, потребностью заказчика и вместительностью транспорта). Грузовики выбираются по принципу минимального использования в уже созданных рейсах. После этого из рассмотрения удаляются склады и магазины без запасов и потребностей соответственно. Описанный шаг повторяется до тех пор, пока все потребители не будут удовлетворены.
	
	В случае, если после рассмотрения всех рёбер остаются потребители с неудовлетворёнными заказами, для каждого из них строятся кратчайшие маршруты до складов с помощью алгоритма Дейкстры\cite{alg:Corman}. После этого вышеописанный алгоритм повторяется для них ещё раз.
	
	Как было отмечено ранее, решаемая задача имеет ряд нюансов. Рассмотрим какое влияние они оказывают на данном этапе.
	\begin{itemize}
		\item Ограничения по времени выполнения заказов в начальном плане не учитываются. Они являются задачей дальнейшей оптимизации.
		\item Транзитные маршруты на данном этапе могут быть проложены в случае, если в между пунктами не задано прямой дороги.
		\item Многопродуктовость\cite{trans:polyprod}. По очередному выбранному пути перевозится максимальное количество каждого товара. 
		\item Ограничение по вместимости. В случае превышения объёма перевозимых товаров вместимости грузовика, на рассматриваемый рейс назначается только часть тар, а остальные откладываются на дополнительный рейс по тому же маршруту (он также может быть разбит на части по тому же принципу). На текущий рейс товары должны назначаться так, чтобы максимально заполнить грузовик, при этом постараться избежать разбиения доставки однотипных товаров по разным маршрутам. Это нужно для эффективности использования транспорта и удобности оптимизации на следующем шаге. Данное описание подходит под формулировку задачи о рюкзаке\cite{alg:Skiena}, поэтому размещение товаров будет производится по этому алгоритму.
	\end{itemize}
	
	С учётом описанных нюансов, метод можно описать следующим образом. Для каждого пункта $P_i$, являющегося потребителем составляется множество дорог $Roads_i$ до пунтов, являющихся складами и имеющими одинаковые товары в запасах и заказах.
	
	\begin{equation}
		\label{roads}
		Roads_i = \{
			d_{ij} 
			| 
			\left\{ \begin{array}{ccc}	
				j = \overline{2, N_a + 1} \\
				\exists l: O_{il} \ne 0, O_{jl} \ne 0\\
			\end{array}	\right.
		\}
	\end{equation}

	Среди всех множеств $Roads_i$ выбирается наименьший элемент $d_{ij}$, после чего создаётся новый маршрут $R_k$, с $v_{ijkl} = min(-O_{il}, O_{jl})$. После этого $d_{ij}$ исключается из $Roads_i$ и выбор переходит к маршруту.
	
	Рассмотрим пример работы алгоритма минимального элемента. Пусть задана система, обозначенная на рисунке \ref{pic:pre_1}. Пунктирными линиями обозначены существующие дороги и расстояния.
	
	\begin{figure}[h!] 
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/max_elem_1.pdf}}
			\caption{Начальное состояние системы}
			\label{pic:pre_1}
		\end{center}
	\end{figure}

	Пусть баланс задан таблицей \ref{init_balance}, объём тары $1.0 m^3$, вместимость грузовика $10.0 m^3$.
	
	\begin{table}[h]
		{\small \begin{center}
			\caption{Начальный баланс системы}
			\label{init_balance}
			\begin{tabular}{| p{5cm} | p{2.5cm} | p{2.5cm} |}
				\hline
				\backslashbox{\textbf{Пункт}}{\textbf{Продукт}} &
				A &
				B \\
				
				\hline
				Стоянка & 
				$0$ &
				$0$ \\
				
				\hline
				Склад 1 & 
				$+10$ &
				$+10$ \\
				
				\hline
				Склад 2 & 
				$+10$ &
				$+10$ \\
				
				\hline
				Магазин 1 & 
				$-8$ &
				$-3$ \\
				
				\hline
				Магазин 2 & 
				$-2$ &
				$-2$ \\
				
				\hline
				Магазин 3 & 
				$0$ &
				$-4$ \\
				
				\hline
				Магазин 4 & 
				$-4$ &
				$0$ \\

				\hline
			\end{tabular}
		\end{center}}
	\end{table}

	После обработки всех рёбер между магазинами и стоянками для системы будут составленны маршруты, обозначенные на рисунке \ref{pic:pre_2} с помощью стрелок. Порядок их назначения будет следующим:
	
	\begin{enumerate}
		\item Кратчайший путь Склад 1 -> Магазин 1. Для него назначается перевозка 8 тар товара А и 2 тары Б. Для оставшейся тары продукта Б выделяется ещё один рейс по этому же маршруту. Заказ магазина 1 выполнен, он исключается из рассмотрения.
		\item Следующий кратчайший путь Склад 1 -> Магазин 2. Назначается перевозка 2 тар продукта А и B.
		\item Последний путь Склад 2 -> Магазин 3. Назначается перевозка 4 тар продукта B.
	
	\end{enumerate}
	
	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/max_elem_2.pdf}}
			\caption{Начальное задания маршрутов}
			\label{pic:pre_2}
		\end{center}
	\end{figure}

	Так как остался Магазин 4 с неудовлетворённым заказом, из-за невозможности удовлетворить его потребностями непосредственно связанными с ним складами, для него осуществляется поиск расстояний до всех складов. Склад 2 расположен на расстоянии $5.0$, склад 1 -- $7.0$. Второй ближе, следовательно из него назначается перевозка на 4 тары продукта A. После этого потребности всех магазинов удовлетворены. Состояние системы после окончания предварительного этапа изображено на рисунке \ref{pic:pre_3}
	
 	\begin{figure}[h]
	 	\begin{center}
	 		{\includegraphics[scale=1.0, angle=0]{img/max_elem_3.pdf}}
	 		\caption{Система после дополнительного задания маршрутов}
	 		\label{pic:pre_3}
	 	\end{center}
	 \end{figure}
 
 	Если оценить состояние грузовиков, то можно отметить неоптимальность созданного плана. Грузоперевозку в магазин 2 можно осуществить на 2-м рейсе, так как в машина загружена неполностью, а удлинение маршрута будет дешевле назначения отдельного рейса. Аналогично совмещается грузоперевозка в 3 и 4 магазины. Поэтому созданный план требует дополнительную обработку.
	
	\subsubsection{Оптимизация плана}
	Основу алгоритма составляет метод потенциалов. Его целью является нахождение оптимального плана\cite{potential}. Действие заключается в следующем.
	
	Каждый узел обладает некоторым значением потенциала $Pot[P]$. Оно отражает значение целевой функции для определённого пункта. Изначально оно задаётся в соответствии с сформированным на первом шаге плане перевозок. Значение складов устанавливается как длительность проезда до стоянки. Значения для магазина $Pot[P_j]$ считается как $Pot[P_j] = Pot[P_i] + Cost_{ij}$, где $Pot[P_i]$ - потенциал пункта, из которого по плану осуществляется доставка груза, $Cost_{ij} = d_{ij}$ - стоимость перевозки груза по дуге $ij$.
	
	Оптимизация производится за счёт рассмотрения альтернативных путей доставки груза в пункт вместо уже запланированных. Это делается при помощи определения значения невязки для каждой дуги. Для пути $P[i] -> P[j]$ оно вычисляется как $Pot[P_i] + Cost_{ij}-Pot[P_j]$. В случае, если данная величина отрицательна это фактически означает, что существует более выгодный маршрут перевозки. Производится пересчёт потенциалов и всех невязок. В случае, если все невязки положительны считается, что оптимальное решение найдено. Иначе, выбирается самая значительная невязка и для неё повторяется описанный шаг.
	
	Обратимся снова к выделенным дополнительным условиям задачи.
	\begin{itemize}
		\item Потенциал пункта зависит от рассматриваемого маршрута.
		
		Например, через один пункт может пролегать два маршрута. Стоимость доставки товара в первом является минимальной, если идёт по кратчайшему пути от нужного склада. Во втором она выше, так как до этого посещаются другие пункты. Значения потенциалов получаются разными, поэтому следует выбирать максимальных из них.
		
		\item Невязка дуги должна отражать то, что при замене доставки в данный \, пункт по иному маршруту, старый маршрут может перестать существовать.
		
		Невязка должна высчитываться как $-Pot[P_j] + Cost_{ij}$. Данная величина равна изменению целевой функции в случае продления маршрута, идущего через $P_i$, и удаление через $P_j$.
		
		\item Значение потенциала также зависит и от рассматриваемого продукта.
		
		Если в пункт не ведёт ни один маршрут, который перевозит или потенциально может перевести некий продукт, то значение потенциала для данного продукта будет бесконечным. Поэтому для каждого товара рассчитываются собственные значения потенциалов. Значение невязки дуги считается минимальным среди невязок по всем продуктам.
	\end{itemize}

	Учтивая перечисленные нюансы следует скорректировать метод.
	
	Отрицательная невязка означает, что для данного пункта, вероятно, возможна более выгодная перевозка взамен существующей. Следует осуществить проверку на соблюдение условий вместимости, наличия достаточного количества товара новом складе и т.д.. Поэтому при обнаружении отрицательной невязки оптимизируемый пункт лишь планируется к дальнейшему рассмотрению.
	
	После подсчёта потенциалов начинается анализ пунктов, к которым ведут дуги с отрицательной невязкой. Рассмотрение производится в порядке возрастания невязок. 
	
	При рассмотрении пункта составляется список всех маршрутов, которые могут пройти через дуги с невязкой. Альтернативные маршруты удлиняются до пункта и берут на себя максимальный объём продукции, который позволяет вместимость их транспорта и запасы на складе\cite{potential:transit}. Маршруты должны рассматриваться в порядке минимальной стоимости перевозки по ним продукции до данного пункта. Данную величину для $k$-го маршрута можно вычислить как $Cost_{ij} \cdot [Vol \cdot $\(\max\limits_{1 \leq i, j \leq N}\)$ (\sum_{l=1}^{N_{Prod}} v_{ijkl})]$. Поэтому, маршруты без свободного места рассматриваться не будут вне зависимости от их близости к пункту\cite{potential:polyprod}. 
	
	На рисунке \ref{pic:pot_1} представлен пример расчёта потенциалов и невязок для системы с опорным планом, описным ранее на рисунке \ref{pic:pre_3}. Штрихпунктирными стрелками указаны невязки между смежными пунктами.
	
 	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/potential_demo_1.pdf}}
			\caption{Вычисление потенциалов и невязок}
			\label{pic:pot_1}
		\end{center}
	\end{figure}

	В первую очередь будет рассмотрена оптимизация маршрутов, ведущих в <<Магазин 4>>, так как она имеет минимальную невязку равную $-4.0$.
	
	Когда вся продукция рассматриваемого маршрута была перераспределена на другие находится значение функции оптимизации $L$ и сравнивается с исходным. Если новое значение ниже, значит новые маршруты более оптимальные, чем старые. Они принимаются за исходный план и процесс оптимизации переходит к следующей итерации.
	
	Таким образом, план маршрутов из описанного примера примет вид, изображённый на рисунке \ref{pic:pot_2}.
	
 	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/potential_demo_2.pdf}}
			\caption{Результат работы метода потенциалов}
			\label{pic:pot_2}
		\end{center}
	\end{figure}
	
	В первую очередь будет продлён маршрут из <<Магазина 3>> в <<Магазин 4>>. После пересчёта потенциалов останутся невязки между магазинами 1 и 2. Первой будет рассмотрена невязка из <<Магазин 1>> в <<Магазин 2>>, так как она меньше, что также придёт к удлинению одного маршрута и удаления другого.

	\subsubsection{Составление расписания}
	После формирования оптимальных маршрутов перевозок для завершения планирования остаётся решить задачу назначения транспорта на каждый маршрут, а также выбора времени каждой перевозки. Составление расписания должно руководствоваться следующими соображениями.
	
	\begin{itemize}
		\item Время завершения каждого маршрута не должно превосходить время \, окончания рабочего дня водителей.
		\item Один транспорт не может одновременно находится сразу на нескольких маршрутах.
		\item При составлении плана желательно избегать ситуаций, когда несколько машин одновременно будут грузиться на одной и той же точке маршрута. 
		
		Это обусловленно тем, что в таком случае нельзя гарантировать, что время обслуживания грузчиками двух и более грузовиков, оказавшихся в одном месте останется неизменным ввиду возможного падения скорости погрузки.
	\end{itemize}
	
	Данная задача может быть решена с использованием метода интервалов \cite{schedule:intervals}, где пункты погрузки рассматриваются как ресурсы, которые могут быть использованы одновременно только в одном интервале. Действие метода заключается в следующем.
	
	Изначально для каждого маршрута рассчитывается время прибытия и отбытия для каждого пункта. У всех маршрутов на этом этапе время начала принимается минимальным возможным, то есть временем начала рабочего дня \, $t_{begin}$.
	
	На одну из машин назначается произвольный маршрут. Время начала и завершения фиксируются в расписании. Выбор маршрута влияет на дальнейшее составление расписания, и может оказаться не самым оптимальным по критерию времени завершения последнего рейса. Но также не стоит и задачи оптимизации по этому параметру -- он должен не превосходить $t_{end}$. В случае, если в результате планирования это условие не выполняется, метод будет использован заново, но с иным выбором первого маршрута.
	
	 Пример подобного расписания приведён на рисунке \ref{pic:sch_1}. Допустим, что в данной транспортной системе имеется три транспортных средства. Пунктирными линиями обозначаются маршруты, не закреплённые в расписании.
	
	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/schedule/1.pdf}}
			\caption{Начальное состояние расписания}
			\label{pic:sch_1}
		\end{center}
	\end{figure}
	
	Далее просматривается список нераспределенных маршрутов. Из него \, выбирается маршрут с минимальным временем начала. Он сравнивается \, с \, маршрутами из расписания на предмет наличия коллизий -- пересечения интервалов погрузки на одинаковых пунктах. В случае, если таковых не найдено, он помещается в расписание с фиксированием транспорта и временем посещения пунктов. 
	
	Если коллизия найдена, то высчитывается величина пересечения --- интервал времени, в который оба маршрута обслуживаются на одном пункте. Время начала рассматриваемого маршрута увеличивается на величину пересечения, после чего он возвращается в список нераспределенных маршрутов. 
	
	Действие повторяется до тех пор, пока все маршруты не окажутся в расписании.
	
	Результатом сравнения всех маршрутов из ранее приведённого примера станет расписание, описываемое рисунком \ref{pic:sch_2}. Второй и третий маршрут имели коллизии с первым, поэтому были смещены. Четвёртый маршрут не был смещён, также он является самым ранним, поэтому закрепляется в расписании.
	
	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/schedule/2.pdf}}
			\caption{Расписание после первой итерации метода}
			\label{pic:sch_2}
		\end{center}
	\end{figure}

	При очередном просмотре смещается второй маршрут из-за коллизии с четвёртым. Расписание принимает вид, указанный на рисунке \ref{pic:sch_3}.
	
	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/schedule/3.pdf}}
			\caption{Расписание после второй итерации метода}
			\label{pic:sch_3}
		\end{center}
	\end{figure}

	Последний незакреплённый маршрут не имеет коллизий. Но так как в данном примере только три транспортных средства, второй маршрут смещается так, чтобы его начало совпало с временем освобождения транспорта. Конечное расписание приведено на рисунке \ref{pic:sch_4}.
	
	\begin{figure}[h]
		\begin{center}
			{\includegraphics[scale=1.0, angle=0]{img/schedule/3.pdf}}
			\caption{Итоговое расписание}
			\label{pic:sch_4}
		\end{center}
	\end{figure}

\subsection*{Вывод}
Результатом аналитической части стала формализация поставленной задачи и описание метода её решения.

Была проанализированна предметная область задачи. Проведён сравнительный анализ с наиболее известными решениями, обозначены их преимущества и недостатки. Выявлены основные особенности транспортировки товаров для малого бизнеса.

На основании проведённого анализа были установленны цели создания метода. Описаны объекты модели, входные и выходные данные. Установленны допущения и ограничения для моделируемых объектов, основанные на особенностях рассматриваемого вида грузоперевозки. Также был описан критерий оптимизации маршрутов доставки.

Была разработана математическая модель исследуемой системы. Обоснован выбор метода оптимизации, приведено его описание. Выделены этапы, описаны способы обработки дополнительных учитываемых факторов.

\pagebreak